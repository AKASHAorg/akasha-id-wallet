# akasha-id-lib
[DID](https://w3c-ccg.github.io/did-spec/) library for AKASHA.id, comprised of a "wallet" (integrated into the Identity Provider, IDP)and a client app.

## DIDClient

To initialize the client, you will need a list of attributes for the application you are creating, such as the application `name`, a short `description`, an app `image URL`, and finally the `app URL`. You can also pass an optional configuration parameter (as an object).

```JavaScript
const config = {
    hubUrls: ['https://examplehub1.com'],
    walletUrl: 'https://akasha.id/#/wallet/',
    debug: true
}
const appInfo = {
  name: 'AKASHA.world',
  description: 'The super cool AKASHA World app!',
  icon: 'https://app.akasha.world/icon.png',
  url: 'https://app.akasha.world'
}
const client = new DIDclient(appInfo, config)
```

**NOTE:** For convenience during development, you can start a local hub server with `npm run testhub`, which will listen on port `8080`.

The next step is to generate the initial request/login link in the app, and then display it as a button or a link for the users to click. You can also put the link in a QR code.

```JavaScript
const link = await client.registrationLink()
// -> https://akasha.id/#/wallet/WyJhIiwiMDVjZjBjNzZmMGMwZTNmNjUwODVhYTA1YmZmODFkMGI3MmI1M2VmOSIsIkVEZUJLekpwUkoyeVhUVnVncFRTQ2c9PSIsMTY4NzQ2NF0=
```

At the same time, attach an event listener for the response coming from the IDP app. The response is sent once the user has accepted or rejected the request. 

```JavaScript
const response = await client.requestProfile()
```

The response object will contain the following attributes, and it should be stored locally (client-side) for future use by the app.

```JavaScript
{
    allowed: true, // or false if the user denyed the request
    claim: { ... }, // an object containing the profile attributes shared by the user
    token: 'e6122c80e7a293901244e5cb87c32546692d5651', // unique ID for this app that is used for future requests
    refreshEncKey: '3gCE799TuL9QN5huAJ+aTg==', // one-time-use encryption key for the next request
}
```

If the app would like to request an updated version of the profile data, it can send a `refreshProfile` request.

```JavaScript
// We get the channel ID for refresh from the user's DID in the claim above
const channel = response['claim']['credentialSubject']['id'].split(':')[2]

// The token and the refreshEncKey values are taked from the previous response (above)
const response = await client.refreshProfile(channel, token, refreshEncKey)

console.log(response) // returns a similar response object to the one in the previous step
```

## DIDWallet

The "wallet" handles requests for the user's profile attributes. It is meant to be used by
the AKASHA.id application, to exchange profile attributes with 3rd party applications.

The main parameter expected is the `id`, a unique string specific to the user. The `id`
will be used to create the user's [DID](https://w3c-ccg.github.io/did-spec/).

It also accepts a configuration parameter (as an object) that contains the `hubUrls`. The
hubs values must be the same as the ones used by the `DIDclient`.

```JavaScript
const AKASHAid = require('akasha-id-lib')

const config = {
    hubUrls: ['https://examplehub1.com'],
    debug: true // display console.log statements for debug purposes
}
// generate a unique ID in the form of an alphanumeric string
const id = AKASHAid.generateId()
// instantiate the wallet
const wallet = new AKASHAid.DIDwallet(id, config)
```

Before we initialize the wallet (basically start the listener for external requests), we need
to define a function that handles requests for updateds on the profile attributes. Below is an
example that uses `localStorage` to persist data.

```JavaScript
const handleRefresh = async (data) => {
  try {
    const localData = JSON.parse(localStorage.getItem(data.token))
    if (!localData) {
      // handle revoked apps
      return
    }
    // import key
    const key = await AKASHAid.crypto.importKey(localData.key)
    // decrypt message
    const msg = await AKASHAid.crypto.decrypt(key, data.msg, 'base64')
    // send the updated claim
    const claim = await wallet.sendClaim({
      channel: msg.channel,
      token: data.token,
      key: localData.key,
      nonce: msg.nonce
    },
    localData.attributes,
    true)
    // persist new claim that was just issued
    localStorage.setItem(claim.token, JSON.stringify({
      key: claim.refreshEncKey,
      attributes: claim.attributes
    }))
  } catch (e) {
    console.log(e)
  }
}

// finally, init the listener
await wallet.init(handleRefresh)
```

After a the user clicks the login link generated by a "client" app, or when a QR code is scanned, they will be taken to the IDP (AKASHA.id app). Once there, the link needs to be parsed in order to get to the relevant request data generated by the 3rd party app (aka the client).

```JavaScript
// Assuming a the link was the following
const link = 'https://akasha.id/#/wallet/WyJhIiwiMDVjZjBjNzZmMGMwZTNmNjUwODVhYTA1YmZmODFkMGI3MmI1M2VmOSIsIkVEZUJLekpwUkoyeVhUVnVncFRTQ2c9PSIsMTY4NzQ2NF0='
// strip https://akasha.id/#/wallet/ from the raw link
const rawRequest = link.substring(27)
// parse the link to get the initial handshake attributes
const request = await wallet.registerApp(rawRequest)
```

The `request` contents will look similar to the object below.

```JavaScript
{
    appInfo: {name: "AKASHA.world", description: "The super cool AKASHA World app!", icon: "https://app.akasha.world/icon.png", url: "https://app.akasha.world"}
    channel: "1ce120a6f8630283db7c434ce74541831b4106a2"
    key: "VCm7C1ci28M+8TFf2LA4PA=="
    nonce: 579482
    token: "4962391a0dbf2abee7e0ea4d07814aa16cc2cefc"
}
```

The AKASHA.id app can now use the `appInfo` data to display a modal/page to the user, informing them about the app that is currently requesting access to the profile elements, as well as displaying a list of available attributes from the profile that can be disclosed to the client app.

```JavaScript
...

// display a modal with data from request.appInfo as well as a list of attributes

...

// collect all the selected attributes in an attributes object
const attributes = { ... }

...

// accept the request and send the claim
const claim = await wallet.sendClaim(request, attributes, true)

// store the new claim
localStorage.setItem(request.token, JSON.stringify(claim))
...

// also store the app in the list of apps we allowed

const apps = {}
// both token and appInfo can be found from wallet.registerApp() above
apps[token] = appInfo
localStorage.setItem('apps', JSON.stringify(apps))
```

You can also use `false` and `null/empty` attributes obj to deny a request.

```JavaScript
await wallet.sendClaim(request, null, false)
```